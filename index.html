<!DOCTYPE html>
<html lang="ta">
<head>
    <meta charset="UTF-8">
    <title>விக்கிமீடியா உலகளாவிய பங்களிப்பாளர் புள்ளிவிவரம்</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #f8f9fa; padding: 20px; }
        .container { max-width: 1000px; margin: auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h2 { color: #2c3e50; text-align: center; border-bottom: 3px solid #007bff; padding-bottom: 10px; }
        .input-area { background: #e9ecef; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        textarea { width: 100%; height: 120px; padding: 10px; border: 1px solid #ced4da; border-radius: 5px; font-size: 14px; box-sizing: border-box; }
        .controls { display: flex; gap: 15px; margin-top: 15px; align-items: center; flex-wrap: wrap; }
        input[type="month"] { padding: 8px; border-radius: 5px; border: 1px solid #ced4da; }
        button { background: #007bff; color: white; border: none; padding: 12px 25px; border-radius: 5px; cursor: pointer; font-weight: bold; width: 100%; transition: 0.3s; }
        button:hover { background: #0056b3; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #dee2e6; padding: 12px; text-align: left; }
        th { background: #007bff; color: white; }
        tr:nth-child(even) { background: #f2f2f2; }
        .project-tag { display: inline-block; background: #d1ecf1; color: #0c5460; padding: 3px 8px; border-radius: 4px; font-size: 11px; margin: 2px; font-weight: bold; border: 1px solid #bee5eb; }
        #loader { display: none; text-align: center; font-weight: bold; color: #d9534f; padding: 20px; }
        .summary-box { margin-top: 20px; padding: 15px; background: #d4edda; border-radius: 8px; text-align: center; font-weight: bold; font-size: 1.2em; color: #155724; }
    </style>
</head>
<body>

<div class="container">
    <h2>விக்கிமீடியா திட்டவாரியான பங்களிப்புகள்</h2>

    <div class="input-area">
        <label><b>பயனர் பெயர்கள் (ஒவ்வொரு வரிசையிலும் ஒன்று):</b></label>
        <textarea id="userList" placeholder="பயனர் பெயரை இங்கே உள்ளிடவும்..."></textarea>
        
        <div class="controls">
            <label>தொடக்கம்: <input type="month" id="startMonth" value="2026-01"></label>
            <label>முடிவு: <input type="month" id="endMonth" value="2026-01"></label>
        </div>
        <button onclick="fetchContributions()">புள்ளிவிவரத்தை உருவாக்கு</button>
    </div>

    <div id="loader">விக்கிமீடியா திட்டங்களிலிருந்து தரவுகள் நேரடியாகத் திரட்டப்படுகின்றன... தயவுசெய்து காத்திருக்கவும்...</div>

    <table>
        <thead>
            <tr>
                <th style="width: 50px;">வ.எண்</th>
                <th>பயனர் பெயர்</th>
                <th>திட்டங்கள் (தொகுப்புகள்)</th>
                <th style="width: 100px;">மொத்தம்</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>

    <div id="summary" class="summary-box" style="display:none;"></div>
</div>

<script>
    // பயனர் பெயரில் உள்ள தேவையற்ற விக்கி குறியீடுகளை நீக்குதல்
    function cleanName(text) {
        if (!text) return "";
        let name = text.replace(/--/g, "").split('(')[0].split(/[0-9]/)[0].trim();
        // விக்கிப்பீடியா பயனர் பெயர் வடிவத்தை உறுதி செய்தல்
        return name.charAt(0).toUpperCase() + name.slice(1);
    }

    async function fetchContributions() {
        const input = document.getElementById('userList').value;
        const users = input.split('\n').map(cleanName).filter(u => u.length > 0);
        
        const startMonth = document.getElementById('startMonth').value;
        const endMonth = document.getElementById('endMonth').value;

        // ISO 8601 வடிவத்திற்கு மாற்றுதல்
        const dateFrom = startMonth + "-01T00:00:00Z";
        const dateTo = endMonth + "-31T23:59:59Z";

        document.getElementById('loader').style.display = "block";
        const tableBody = document.getElementById('tableBody');
        tableBody.innerHTML = "";
        let grandTotal = 0;

        for (let i = 0; i < users.length; i++) {
            const user = users[i];
            let userTotal = 0;
            let projectBreakdown = "";

            try {
                // 1. Meta-Wiki API மூலம் இணைக்கப்பட்ட திட்டங்களை கண்டறிதல்
                const authUrl = `https://meta.wikimedia.org/w/api.php?action=query&meta=centralauth&ucuser=${encodeURIComponent(user)}&format=json&origin=*`;
                const authRes = await fetch(authUrl);
                const authData = await authRes.json();

                if (authData.query && authData.query.centralauth && authData.query.centralauth.attached) {
                    const projects = authData.query.centralauth.attached;

                    // 2. ஒவ்வொரு திட்டத்திலும் குறிப்பிட்ட காலத்தில் செய்த தொகுப்புகளை கணக்கிடுதல்
                    for (let p of projects) {
                        const projectApi = p.url.replace("http://", "https://") + "/w/api.php";
                        // MediaWiki usercontribs API
                        const contribUrl = `${projectApi}?action=query&list=usercontribs&ucuser=${encodeURIComponent(user)}&ucstart=${dateTo}&ucend=${dateFrom}&uclimit=500&format=json&origin=*`;
                        
                        const cRes = await fetch(contribUrl);
                        const cData = await cRes.json();

                        if (cData.query && cData.query.usercontribs) {
                            const count = cData.query.usercontribs.length;
                            if (count > 0) {
                                userTotal += count;
                                let pName = p.wiki.replace("wiki", "");
                                projectBreakdown += `<span class="project-tag">${pName}: ${count}</span> `;
                            }
                        }
                    }
                }

                grandTotal += userTotal;
                tableBody.innerHTML += `
                    <tr>
                        <td>${i + 1}</td>
                        <td><b>${user}</b></td>
                        <td>${projectBreakdown || '<span style="color:gray">பங்களிப்புகள் இல்லை</span>'}</td>
                        <td><b style="color:#007bff">${userTotal}</b></td>
                    </tr>`;
            } catch (err) {
                console.error("Error fetching for " + user, err);
            }
        }

        document.getElementById('loader').style.display = "none";
        const summary = document.getElementById('summary');
        summary.style.display = "block";
        summary.innerText = `அனைத்து பயனர்களின் ஒட்டுமொத்தப் பங்களிப்புகள்: ${grandTotal}`;
    }
</script>

</body>
</html>
