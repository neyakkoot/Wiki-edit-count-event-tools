<!DOCTYPE html>
<html lang="ta">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>விக்கிமீடியா புள்ளிவிவரக் கருவி</title>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #f0f4f8; padding: 20px; color: #333; }
        .container { max-width: 1000px; margin: auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 5px 25px rgba(0,0,0,0.1); }
        h2 { color: #0056b3; text-align: center; border-bottom: 2px solid #0056b3; padding-bottom: 10px; }
        .input-area { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        textarea { width: 100%; height: 120px; padding: 12px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px; box-sizing: border-box; }
        .controls { display: flex; gap: 15px; margin-top: 15px; align-items: center; flex-wrap: wrap; }
        input[type="month"] { padding: 8px; border-radius: 5px; border: 1px solid #ccc; }
        button { background: #007bff; color: white; border: none; padding: 10px 25px; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 15px; }
        button:hover { background: #0056b3; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; }
        th, td { border: 1px solid #dee2e6; padding: 12px; text-align: left; }
        th { background: #007bff; color: white; }
        tr:nth-child(even) { background: #f2f2f2; }
        .tag { display: inline-block; background: #e1f5fe; color: #0277bd; padding: 3px 8px; border-radius: 4px; font-size: 11px; margin: 2px; border: 1px solid #b3e5fc; font-weight: bold; }
        #loading { display: none; text-align: center; font-weight: bold; color: #d9534f; padding: 15px; }
        .summary-box { margin-top: 20px; padding: 15px; background: #d4edda; color: #155724; border-radius: 8px; text-align: center; font-size: 1.2em; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h2>விக்கிமீடியா திட்டவாரியான புள்ளிவிவரம் (CentralAuth Style)</h2>

    <div class="input-area">
        <label><b>பயனர் பெயர்கள் (வரிசைக்கு ஒன்று):</b></label>
        <textarea id="userList" placeholder="--Subisena (பேச்சு) 09:57, 31 சனவரி 2026 (UTC)..."></textarea>
        
        <div class="controls">
            <div>
                <label>தொடக்கம்: </label>
                <input type="month" id="startMonth" value="2026-01">
            </div>
            <div>
                <label>முடிவு: </label>
                <input type="month" id="endMonth" value="2026-01">
            </div>
            <button onclick="getCentralStats()">தரவுகளைப் பெறு</button>
        </div>
    </div>

    <div id="loading">CentralAuth தரவுகள் சேகரிக்கப்படுகின்றன... தயவுசெய்து காத்திருக்கவும்...</div>

    <table id="resultTable">
        <thead>
            <tr>
                <th style="width: 50px;">வ.எண்</th>
                <th>பயனர் பெயர்</th>
                <th>விக்கித் திட்டங்கள் (பங்களிப்புகள்)</th>
                <th style="width: 100px;">மொத்தம்</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>

    <div id="finalSummary" class="summary-box" style="display:none;"></div>
</div>

<script>
    // பயனர் பெயரில் உள்ள குறியீடுகளை நீக்கும் செயல்பாடு
    function cleanName(rawText) {
        if (!rawText) return "";
        // கையொப்பத்தில் உள்ள தேவையற்றவற்றை நீக்குதல்
        let name = rawText.replace(/--/g, "").trim();
        name = name.split('(')[0].split(/[0-9]/)[0].trim(); 
        return name;
    }

    async function getCentralStats() {
        const input = document.getElementById('userList').value;
        const rawLines = input.split('\n').filter(l => l.trim() !== "");
        const startMonth = document.getElementById('startMonth').value;
        const endMonth = document.getElementById('endMonth').value;
        
        const dateFrom = `${startMonth}-01T00:00:00Z`;
        const dateTo = `${endMonth}-28T23:59:59Z`; // பிப்ரவரி கருதி 28 அல்லது 31 ஆக API ஏற்கும்

        const loader = document.getElementById('loading');
        const tableBody = document.getElementById('tableBody');
        const summary = document.getElementById('finalSummary');

        loader.style.display = "block";
        tableBody.innerHTML = "";
        summary.style.display = "none";

        let allUsersTotal = 0;

        for (let i = 0; i < rawLines.length; i++) {
            const user = cleanName(rawLines[i]);
            if (!user) continue;

            let userTotal = 0;
            let projectBreakdown = "";

            try {
                // விக்கிமீடியா மைய API (Meta-Wiki) மூலம் பயனர் பங்களித்துள்ள அனைத்து திட்டங்களையும் பெறுதல்
                const centralUrl = `https://meta.wikimedia.org/w/api.php?action=query&meta=centralauth&ucuser=${encodeURIComponent(user)}&format=json&origin=*`;
                const response = await fetch(centralUrl);
                const data = await response.json();

                if (data.query && data.query.centralauth && data.query.centralauth.attached) {
                    const projects = data.query.centralauth.attached;

                    // ஒவ்வொரு இணைக்கப்பட்ட திட்டத்திலும் குறிப்பிட்ட காலத்தில் செய்த பங்களிப்புகளைச் சரிபார்க்க
                    for (let proj of projects) {
                        const wikiUrl = proj.url.replace("http://", "https://") + "/w/api.php";
                        // குறிப்பிட்ட கால இடைவெளிக்கான பங்களிப்புகளைக் கேட்கிறோம்
                        const statsUrl = `${wikiUrl}?action=query&list=usercontribs&ucuser=${encodeURIComponent(user)}&ucstart=${dateTo}&ucend=${dateFrom}&uclimit=500&format=json&origin=*`;
                        
                        const sRes = await fetch(statsUrl);
                        const sData = await sRes.json();

                        if (sData.query && sData.query.usercontribs) {
                            const count = sData.query.usercontribs.length;
                            if (count > 0) {
                                userTotal += count;
                                // திட்டத்தின் சுருக்கப் பெயரை மட்டும் காட்ட (எ.கா: ta.wikipedia)
                                const shortName = proj.wiki.replace("wiki", ".wikipedia").replace("wiktionary", ".wiktionary");
                                projectBreakdown += `<span class="tag">${shortName}: ${count}</span>`;
                            }
                        }
                    }
                }

                allUsersTotal += userTotal;
                tableBody.innerHTML += `
                    <tr>
                        <td>${i + 1}</td>
                        <td><b>${user}</b></td>
                        <td>${projectBreakdown || '<i style="color:gray;">இந்தக் காலக்கட்டத்தில் பங்களிப்புகள் இல்லை</i>'}</td>
                        <td><b style="color:#007bff">${userTotal}</b></td>
                    </tr>`;

            } catch (err) {
                console.error("Error for " + user, err);
            }
        }

        loader.style.display = "none";
        summary.style.display = "block";
        summary.innerHTML = `அனைத்து பயனர்களின் மொத்தப் பங்களிப்புகள்: ${allUsersTotal}`;
    }
</script>

</body>
</html>
