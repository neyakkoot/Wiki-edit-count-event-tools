<!DOCTYPE html>
<html lang="ta">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>விக்கிமீடியா பங்களிப்பாளர் புள்ளிவிவரம்</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f0f2f5; padding: 20px; }
        .container { max-width: 1000px; margin: auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        h2 { color: #1a73e8; text-align: center; border-bottom: 2px solid #1a73e8; padding-bottom: 10px; }
        .setup-box { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #ddd; }
        textarea { width: 100%; height: 120px; padding: 12px; border-radius: 6px; border: 1px solid #ccc; font-size: 14px; box-sizing: border-box; }
        .date-row { display: flex; gap: 15px; margin-top: 15px; flex-wrap: wrap; }
        input[type="month"] { padding: 10px; border-radius: 5px; border: 1px solid #ccc; }
        button { background: #1a73e8; color: white; border: none; padding: 12px 25px; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 16px; transition: 0.3s; }
        button:hover { background: #1557b0; }
        table { width: 100%; border-collapse: collapse; margin-top: 25px; }
        th, td { border: 1px solid #dee2e6; padding: 12px; text-align: left; }
        th { background: #f1f3f4; color: #5f6368; text-transform: uppercase; font-size: 13px; }
        tr:hover { background: #f8f9fa; }
        .project-badge { display: inline-block; background: #e8f0fe; color: #1967d2; padding: 3px 8px; border-radius: 4px; font-size: 11px; margin: 2px; font-weight: bold; border: 1px solid #c2d7ff; }
        #loader { display: none; text-align: center; padding: 20px; color: #1a73e8; font-weight: bold; }
        .summary-card { margin-top: 20px; padding: 20px; background: #e7f3ff; border-radius: 10px; text-align: center; font-size: 1.2em; font-weight: bold; color: #174ea6; }
    </style>
</head>
<body>

<div class="container">
    <h2>விக்கிமீடியா திட்டவாரியான பங்களிப்புகள்</h2>

    <div class="setup-box">
        <label><b>பயனர் பெயர்கள் (கையொப்பத்துடன் இருக்கலாம்):</b></label>
        <textarea id="userList" placeholder="--Subisena (பேச்சு) 09:57, 31 சனவரி 2026 (UTC)"></textarea>
        
        <div class="date-row">
            <div>
                <label>தொடக்கம்: </label>
                <input type="month" id="startMonth" value="2026-01">
            </div>
            <div>
                <label>முடிவு: </label>
                <input type="month" id="endMonth" value="2026-01">
            </div>
            <button onclick="processContributions()">புள்ளிவிவரத்தை உருவாக்கு</button>
        </div>
    </div>

    <div id="loader">விக்கிமீடியா திட்டங்களிலிருந்து தரவுகள் திரட்டப்படுகின்றன...</div>

    <table id="results">
        <thead>
            <tr>
                <th style="width: 50px;">வ.எண்</th>
                <th>பயனர் பெயர்</th>
                <th>திட்டங்கள் வாரியாக (தொகுப்புகள்)</th>
                <th style="width: 100px;">மொத்தம்</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>

    <div id="summary" class="summary-card" style="display:none;"></div>
</div>

<script>
    // 1. விக்கிப்பீடியா கையொப்பத்திலிருந்து தூய பயனர் பெயரைப் பிரித்தல்
    function cleanUsername(input) {
        if (!input) return "";
        // கையொப்பத்தில் உள்ள --, (பேச்சு), எண்கள், தேதி ஆகியவற்றை நீக்கும் Regex
        let name = input.replace(/--/g, "").split('(')[0].split(/[0-9]/)[0].trim();
        return name;
    }

    async function processContributions() {
        const input = document.getElementById('userList').value;
        const users = input.split('\n').map(cleanUsername).filter(u => u.length > 0);
        
        // தேதி வரம்புகள் (MediaWiki API Format)
        const start = document.getElementById('startMonth').value + "-01T00:00:00Z";
        const end = document.getElementById('endMonth').value + "-28T23:59:59Z";

        document.getElementById('loader').style.display = "block";
        const tableBody = document.getElementById('tableBody');
        tableBody.innerHTML = "";
        let grandTotal = 0;

        for (let i = 0; i < users.length; i++) {
            const user = users[i];
            let userGrandTotal = 0;
            let projectBreakdown = "";

            try {
                // 2. CentralAuth API மூலம் பயனர் இணைக்கப்பட்டுள்ள அனைத்து திட்டங்களின் பட்டியலைப் பெறுதல்
                const authUrl = `https://meta.wikimedia.org/w/api.php?action=query&meta=centralauth&ucuser=${encodeURIComponent(user)}&format=json&origin=*`;
                const authRes = await fetch(authUrl);
                const authData = await authRes.json();

                if (authData.query && authData.query.centralauth && authData.query.centralauth.attached) {
                    const projects = authData.query.centralauth.attached;

                    // 3. ஒவ்வொரு திட்டத்தின் API-க்கும் சென்று பங்களிப்புகளைக் கணக்கிடுதல்
                    // குறிப்பு: இது Pathoschild கருவியின் அதே தர்க்கத்தைப் பயன்படுத்துகிறது
                    for (let p of projects) {
                        const projectApi = p.url.replace("http://", "https://") + "/w/api.php";
                        const contribUrl = `${projectApi}?action=query&list=usercontribs&ucuser=${encodeURIComponent(user)}&ucstart=${end}&ucend=${start}&uclimit=500&format=json&origin=*`;
                        
                        const cRes = await fetch(contribUrl);
                        const cData = await cRes.json();

                        if (cData.query && cData.query.usercontribs) {
                            const count = cData.query.usercontribs.length;
                            if (count > 0) {
                                userGrandTotal += count;
                                let pLabel = p.wiki.replace("wiki", "");
                                projectBreakdown += `<span class="project-badge">${pLabel}: ${count}</span> `;
                            }
                        }
                    }
                }

                grandTotal += userGrandTotal;
                tableBody.innerHTML += `
                    <tr>
                        <td>${i + 1}</td>
                        <td><b>${user}</b></td>
                        <td>${projectBreakdown || '<span style="color:gray">பங்களிப்புகள் இல்லை</span>'}</td>
                        <td><b style="color:#1a73e8">${userGrandTotal}</b></td>
                    </tr>`;

            } catch (err) {
                console.error("Error fetching data for " + user, err);
            }
        }

        document.getElementById('loader').style.display = "none";
        const summary = document.getElementById('summary');
        summary.style.display = "block";
        summary.innerHTML = `அனைத்து பயனர்களின் ஒட்டுமொத்தப் பங்களிப்புகள்: ${grandTotal}`;
    }
</script>

</body>
</html>
